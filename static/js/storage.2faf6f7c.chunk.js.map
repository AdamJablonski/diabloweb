{"version":3,"sources":["storage.js","fs.js"],"names":["__webpack_require__","r","__webpack_exports__","_fs__WEBPACK_IMPORTED_MODULE_0__","fs","create_fs","window","addEventListener","_ref","data","source","method","then","_ref2","files","postMessage","_ref3","clear","importStorage","Promise","resolve","reject","done","frame","document","createElement","contentWindow","src","style","display","body","appendChild","setTimeout","downloadFile","_callee","store","name","file","blob","url","lnk","C_Projects_diabloweb_diabloweb_node_modules_babel_runtime_regenerator__WEBPACK_IMPORTED_MODULE_1___default","a","wrap","_context","prev","next","get","toLowerCase","sent","Blob","type","URL","createObjectURL","setAttribute","click","removeChild","revokeObjectURL","console","error","concat","stop","_x3","_create_fs","apply","this","arguments","_callee2","load","_i","_Object$entries","_ref7","_name","_data","_files","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_iterator","_step","_ref6","_ref5","_context2","IdbKvStore","Map","t0","Object","json","t1","entries","call","length","C_Projects_diabloweb_diabloweb_node_modules_babel_runtime_helpers_esm_slicedToArray__WEBPACK_IMPORTED_MODULE_0__","set","undefined","Symbol","iterator","value","t2","return","finish","DownloadFile","abrupt","update","delete","remove","t3"],"mappings":"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","file":"static/js/storage.2faf6f7c.chunk.js","sourcesContent":["import create_fs from './fs';\r\n\r\nconst fs = create_fs();\r\nwindow.addEventListener('message', ({data, source}) => {\r\n  if (data.method === 'transfer') {\r\n    fs.then(({files}) => {\r\n      source.postMessage({method: 'storage', files}, '*');\r\n    });\r\n  } else if (data.method === 'clear') {\r\n    fs.then(({clear}) => clear());\r\n  }\r\n});","import IdbKvStore from  'idb-kv-store';\r\n\r\nconst importStorage = () => new Promise((resolve, reject) => {\r\n  let done = false;\r\n  const frame = document.createElement('iframe');\r\n  window.addEventListener('message', ({data}) => {\r\n    if (data.method === 'storage' && !done) {\r\n      done = true;\r\n      resolve(data.files);\r\n      frame.contentWindow.postMessage({method: 'clear'}, '*');\r\n    }\r\n  });\r\n  frame.addEventListener('load', () => {\r\n    frame.contentWindow.postMessage({method: 'transfer'}, '*');\r\n  });\r\n  frame.addEventListener('error', () => {\r\n    if (!done) {\r\n      done = true;\r\n      resolve(null);\r\n    }\r\n  });\r\n  frame.src = \"https://diablo.rivsoft.net/storage.html\";\r\n  frame.style.display = \"none\";\r\n  document.body.appendChild(frame);\r\n  setTimeout(() => {\r\n    if (!done) {\r\n      done = true;\r\n      resolve(null);\r\n    }\r\n  }, 10000);\r\n});\r\n\r\nasync function downloadFile(store, name) {\r\n  const file = await store.get(name.toLowerCase());\r\n  if (file) {\r\n    const blob = new Blob([file], {type: 'binary/octet-stream'});\r\n    const url = URL.createObjectURL(blob);\r\n    const lnk = document.createElement('a');\r\n    lnk.setAttribute('href', url);\r\n    lnk.setAttribute('download', name);\r\n    document.body.appendChild(lnk);\r\n    lnk.click();\r\n    document.body.removeChild(lnk);\r\n    URL.revokeObjectURL(url);\r\n  } else {\r\n    console.error(`File ${name} does not exist`);\r\n  }\r\n}\r\n\r\nexport default async function create_fs(load) {\r\n  try {\r\n    const store = new IdbKvStore('diablo_fs');\r\n    const files = new Map();\r\n    for (let [name, data] of Object.entries(await store.json())) {\r\n      files.set(name, data);\r\n    }\r\n    if (load) {\r\n      const files = await importStorage();\r\n      if (files) {\r\n        for (let [name, data] of files) {\r\n          files.set(name, data);\r\n          store.set(name, data);\r\n        }\r\n      }\r\n    }\r\n    window.DownloadFile = name => downloadFile(store, name);\r\n    return {\r\n      files,\r\n      update: (name, data) => store.set(name, data),\r\n      delete: name => store.remove(name),\r\n      clear: () => store.clear(),\r\n    };\r\n  } catch (e) {\r\n    window.DownloadFile = () => console.error('IndexedDB is not supported');\r\n    return {\r\n      files: new Map(),\r\n      update: () => Promise.resolve(),\r\n      delete: () => Promise.resolve(),\r\n      clear: () => Promise.resolve(),\r\n    };\r\n  }  \r\n}\r\n"],"sourceRoot":""}